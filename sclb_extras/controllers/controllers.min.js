$.Controller("SCPTController",{},{playIsCorrect:function(isRight){var sound=this.options.model.incorrectSound;isRight&&(sound=this.options.model.correctSound),$("#jp_"+this.options.model.containerId).jPlayer("setMedia",{mp3:sound,oga:sound.substring(0,sound.lastIndexOf("."))+".ogg"}).jPlayer("play")},completed:function(){$("#"+this.options.model.containerId).trigger("sc."+this.options.model.questionType+".complete",this.options.model.getState())},reset:function(onlyTrigger){onlyTrigger||(this.options.model.reinit(),this.init(),this.updateStatus(),$("#inputf_"+this.options.model.containerId).focus());var state=this.options.model.getState();delete state.curScore,$("#"+this.options.model.containerId).trigger("sc."+this.options.model.questionType+".reset",state)},getState:function(){return this.options.model.getState()},setState:function(jsonObj){this.options.model.setState(jsonObj),this.init()},showAnswer:function(){},fireDrag:function(id){try{this.options.model.fromKeyBoard=!0,$("#"+id).simulate("drag",{dx:0,dy:0}),this.options.model.fromKeyBoard=!1}catch(e){}},switchToNext:function(){var ind=this.options.model.currentIndex,rarr=this.options.model.returnRandomOrder(this.options.model.pointsArr.length);$("#"+this.options.model.getIdByIndex(rarr[ind])).removeClass("sc-selected"),this.options.model.currentIndex=(ind+1)%this.options.model.pointsArr.length,this.options.model.selectedObject=rarr[this.options.model.currentIndex];var obj=$("#"+this.options.model.getIdByIndex(this.options.model.selectedObject));this.options.model.startCoords&&(this.options.model.startCoords[this.options.model.selectedObject]||(this.options.model.startCoords[this.options.model.selectedObject]={x:obj.position().left,y:obj.position().top})),obj.addClass("sc-selected")},handleKeys:function(e){var self=e.data.self,_objid=self.options.model.getIdByIndex(self.options.model.selectedObject),draggable=$("#"+_objid),container=$("#"+self.options.model.containerId),position=draggable.position();if(self.options.model.pointsArr[self.options.model.selectedObject]>0&&9!=e.keyCode&&32!=e.keyCode)return!1;try{if(e.altKey)switch(e.keyCode){case 85:return e.data.self.reset(!1),!1;case 81:e.data.self.showAnswer(),e.data.self.completed();break;default:return!0}else switch(e.keyCode){case 32:e.ctrlKey||self.switchToNext();break;case 13:self.fireDrag(_objid);break;case 37:position.left-=10;break;case 38:position.top-=10;break;case 39:position.left+=10;break;case 40:position.top+=10;break;default:return!0}}catch(e){}position&&self.options.model.isChrome&&(position.left=position.left+.5,position.top=position.top+.5),position&&"true"!=draggable.data("dropped")&&position.left>=0&&position.top>=0&&position.left+draggable.width()<=container.width()&&position.top+draggable.height()<=container.height()&&draggable.css(position),e.preventDefault()},init:function(){var self=this,contId=self.options.model.containerId;this.options.model.correctSound&&(this.options.model.correctSound&&new Audio(this.options.model.correctSound).load(),this.options.model.incorrectSound&&new Audio(this.options.model.incorrectSound).load(),$("#jp_"+contId).jPlayer({ready:function(){$(this).jPlayer("setMedia",{preload:"none",mp3:self.options.model.correctSound,oga:self.options.model.correctSound.substring(0,self.options.model.correctSound.lastIndexOf("."))+".ogg"})},swfPath:"lib/jPlayer",wmode:"window",supplied:"mp3, oga",solution:"html, flash"})),-1!=window.location.protocol.indexOf("ibooks")&&$(".sc-mainDiv").css("line-height","90%"),$("#restart_"+self.options.model.containerId).html(self.options.model.restartText),$("#finish_"+self.options.model.containerId).html(self.options.model.finishText),this.bindEvents(self),self.updateStatus(),self.options.model.isIpad||this.bindKeyEvents(),0==this.options.model.showRestart&&$("#restart_"+self.options.model.containerId).hide(),0==this.options.model.maxScore&&$("#statusText_"+self.options.model.containerId).css({visibility:"hidden"}),null!=navigator.userAgent.match(/iPad/i)&&$("#hintText_"+self.options.model.containerId).html(""),$("#"+self.options.model.containerId).addTouch()},bindKeyEvents:function(){var self=this,contId=self.options.model.containerId;this.options.model.isAndroid||$("#"+contId).click(function(){$("#inputf_"+contId).focus()}),$("#inputf_"+contId).focusin(function(){$("#"+contId).children().first().addClass("sc-selectedQuestion")}).focusout(function(){$("#"+contId).children().first().removeClass("sc-selectedQuestion")}).bind("keyup",{self:self},self.handleKeys).bind("keypress",{self:self},function(evt){self.options.model.keyPressed=evt.keyCode}).bind("keydown",function(evt){(32==evt.keyCode||evt.keyCode>=37&&evt.keyCode<=40)&&evt.preventDefault()})},disableActivity:function(){$("#inputf_"+this.options.model.containerId).blur(),$("#"+this.options.model.containerId).find("*").unbind()},bindEvents:function(self){},updateStatus:function(self){}}),SCPTController("Crosswords",{},{init:function(){var m=this.options.model;m.attempts++;var container=$("#"+m.containerId);container.find(".crosswordDefs").getNiceScroll().remove(),container.html(this.options.template,{id:m.containerId,color:m.backgroundColor,width:m.width,height:m.height,dimensions:m.dimensions,acrossText:m.acrosstext,downText:m.downtext,maxScore:m.maxScore,across:m.across,down:m.down,state:m.state}),this._super(),this.options.model.isIpad&&this.bindKeyEvents(),this.refreshView(!0);var scroll_w="ontouchstart"in document.documentElement?4:10,mask=container.parents(get_greymatter_class_name()),add_scrollers=$.oneshot(function(){var ctx={cursorwidth:scroll_w};"ontouchstart"in document.documentElement||(ctx.cursoropacitymax=1,ctx.cursoropacitymin=1),$.each(["down","across"],function(i,v){var id1="#cwdefs-"+v+"-"+m.containerId,id2="#crossword-defs-"+v+"-"+m.containerId,x=$(id1).niceScroll(id2,$.extend({hwacceleration:!0},ctx));0==mask.length&&(x.rail.css("z-index",99),x.railh.css("z-index",99))})});0==mask.length||mask.is(":visible")?add_scrollers():(mask.bind("isVisible",function(){add_scrollers();var ns=container.find(".crosswordDefs").getNiceScroll();ns.each(function(){this.updateScrollBar()}),ns.show()}),mask.bind("isHidden",function(){container.find(".crosswordDefs").getNiceScroll().hide()}));var hint_text_container=$("#hintText_"+m.containerId);void 0!==hint_text_container.html()&&""!=hint_text_container.html()||hint_text_container.hide()},bindKeyEvents:function(){var self=this,contId=self.options.model.containerId;this.options.model.isAndroid||$("#"+contId).click(function(){$("#inputf_"+contId).focus()}),$("#inputf_"+contId).focusin(function(){$("#"+contId).children().first().addClass("sc-selectedQuestion")}).focusout(function(){$("#"+contId).children().first().removeClass("sc-selectedQuestion")}).bind("keyup",{self:self},self.handleKeys).bind("keypress",{self:self},function(evt){self.options.model.keyPressed.push(evt.keyCode)}).bind("keydown",function(evt){(8==evt.keyCode||9==evt.keyCode||32==evt.keyCode||evt.keyCode>=37&&evt.keyCode<=40)&&evt.preventDefault()})},bindEvents:function(self){var preventKeys=[8,9,32,37,38,39,40];self=this;$("#restart_"+this.options.model.containerId).bind("click",function(){self.reset()}),$(".crosswordCell").bind("click",function(contId,self){return function(e){var tarr=$(this).attr("id").split("_");self.options.model.prevCell=[self.options.model.activeCell[0],self.options.model.activeCell[1]],self.options.model.activeCell=[parseInt(tarr[2]),parseInt(tarr[3])],self.options.model.firstCell&&self.restoreCellPosition(self.options.model.firstCell,self),$(this).val(""),this.coords=$(this).position(),cellid=self.getCellIdString(contId,this.coords),$(cellid).click().focus(),this.pos=[parseInt(tarr[2]),parseInt(tarr[3])],self.options.model.firstCell=this,self.refreshView()}}(this.options.model.containerId,self)).bind("keyup",{self:self},function(e){e.data.self.options.model;var targetInput=$("#inputf_"+e.data.self.options.model.containerId);e.currentTarget=targetInput[0],targetInput.trigger(e),$(targetInput[0]).click(),$(targetInput[0]).focus();cellid,cellid,$(cellid).is(":focus")}).bind("keypress",{self:self},function(evt){self.options.model.keyPressed.push(evt.keyCode)}),$("#"+this.options.model.containerId).find(".crosswordDefs").eq(0).find(".crosswordDef").bind("click",function(){var m=self.options.model,coord=($(this).attr("data-cell")+"").split("#");self.options.model.direction="across",self.options.model.outerDirection=!0;var id=$(this).attr("id")+"";self.options.model.outerWord=self.options.model.dictionary[id.substr(id.lastIndexOf("_")+1)],cellid=self.getCellIdString(m.containerId,coord),$(cellid).click(),$(cellid).focus()}),$("#"+this.options.model.containerId).find(".crosswordDefs").eq(1).find(".crosswordDef").bind("click",function(){var m=self.options.model,coord=($(this).attr("data-cell")+"").split("#");self.options.model.direction="down",self.options.model.outerDirection=!0;var id=$(this).attr("id")+"";self.options.model.outerWord=self.options.model.dictionary[id.substr(id.lastIndexOf("_")+1)],cellid=self.getCellIdString(m.containerId,coord),$(cellid).click(),$(cellid).focus()}),$("#finish_"+self.options.model.containerId).bind("click",function(){return self.finishedState=self.getState(),self.answerShowing=!1,$("#show_answers_"+self.options.model.containerId).show(),self.completed(),!1}),$("#show_answers_"+self.options.model.containerId).bind("click",function(){return self.answerShowing?(self.setState(self.finishedState),$("#show_answers_"+self.options.model.containerId).html("Show Answers"),$("#show_answers_"+self.options.model.containerId).show(),self.answerShowing=!1):(self.showAnswer(),self.answerShowing=!0,$("#show_answers_"+self.options.model.containerId).html("Hide Answers")),!1}),$("#inputf_"+self.options.model.containerId).bind("keydown",function(evt){preventKeys.indexOf(evt.keyCode)>-1&&evt.preventDefault()})},restoreCellPosition:function(cell,self){$(cell).css({left:self.options.model.firstCell.coords.left+"px",top:self.options.model.firstCell.coords.top+"px"})},switchWord:function(ind){for(var list=$("#"+this.options.model.containerId).find(".crosswordDef"),p="",i=0;i<list.length;i++)list.eq(i).hasClass("sc-selected")&&(p=list.eq((i+ind)%list.length));p&&p.click()},showAnswer:function(){var m=this.options.model;m.isFinished=!0;for(var i=0;i<m.down.length;i++)for(var t=0;t<m.down[i].word.length;t++)$("#cellinput_"+m.containerId+"_"+m.down[i].x_pos+"_"+(m.down[i].y_pos+t)).val(m.down[i].word[t]);for(i=0;i<m.across.length;i++)for(t=0;t<m.across[i].word.length;t++)$("#cellinput_"+m.containerId+"_"+(m.across[i].x_pos+t)+"_"+m.across[i].y_pos).val(m.across[i].word[t]);this.refreshView()},handleKeys:function(e){var m=e.data.self.options.model;if(m.prevCell=[m.activeCell[0],m.activeCell[1]],e.altKey)switch(e.keyCode){case 85:return e.data.self.reset(!1),!1;case 81:e.data.self.showAnswer(),e.data.self.completed();break;case 77:e.data.self.switchWord(1);break;case 80:e.data.self.switchWord(-1);break;default:return!1}else switch(e.keyCode){case 37:m.keyPressed.shift(),m.activeCell[0]>0&&-1!=m.state[m.activeCell[0]-1][m.activeCell[1]]&&m.activeCell[0]--;break;case 38:m.keyPressed.shift(),m.activeCell[1]>0&&-1!=m.state[m.activeCell[0]][m.activeCell[1]-1]&&m.activeCell[1]--;break;case 39:m.keyPressed.shift(),m.activeCell[0]<m.state[0].length-1&&-1!=m.state[m.activeCell[0]+1][m.activeCell[1]]&&m.activeCell[0]++;break;case 40:m.keyPressed.shift(),m.activeCell[1]<m.state.length-1&&-1!=m.state[m.activeCell[0]][m.activeCell[1]+1]&&m.activeCell[1]++;break;case 46:m.keyPressed.shift(),$("#cellinput_"+e.data.self.options.model.containerId+"_"+m.activeCell[0]+"_"+m.activeCell[1]).val("");break;case 8:e.data.self.options.model.isAndroid||($("#cellinput_"+e.data.self.options.model.containerId+"_"+m.activeCell[0]+"_"+m.activeCell[1]).val(""),e.data.self.toPrevCell()),m.keyPressed.shift(),e.preventDefault();break;case 20:case 17:case 46:case 40:case 35:case 13:case 27:case 36:case 45:case 37:case 34:case 33:case 39:case 16:case 9:case 38:case 116:case 18:return!0;default:var code=e.keyCode,character=String.fromCharCode(m.keyPressed.shift()||e.which).toUpperCase();return 188==code&&(character=","),190==code&&(character="."),229!=code&&$("#cellinput_"+e.data.self.options.model.containerId+"_"+m.activeCell[0]+"_"+m.activeCell[1]).val(character),$(".crosswordCell").each(function(){var original=$(this).val();original&&original.length>1&&$(this).val(original[0].toUpperCase())}),e.data.self.toNextCell(),!0}e.preventDefault(),e.data.self.refreshView()},refreshView:function(isReset){var m=this.options.model;m.prevCell&&$("#cellinput_"+m.containerId+"_"+m.prevCell[0]+"_"+m.prevCell[1]).removeClass("sc-selected");var tgt=m.activeCell[0]+"_"+m.activeCell[1];$("#cellinput_"+m.containerId+"_"+tgt).addClass("sc-selected");for(var isSameWord=!1,i=0;i<m.selectedWord.length;i++)tgt==m.selectedWord[i]&&(isSameWord=!0);if(isReset||!isSameWord){for(i=0;i<m.selectedWord.length;i++)$("#cellinput_"+m.containerId+"_"+m.selectedWord[i]).removeClass("highlighted");m.selectedWord.index&&$("#def_"+m.containerId+"_"+m.selectedWord.index).removeClass("sc-selected"),m.selectedWord=[];var tobj=m.dictionary[m.state[m.activeCell[0]][m.activeCell[1]]];if(m.outerDirection&&m.outerWord&&(tobj=m.outerWord),m.selectedWord.index=tobj.index,$("#def_"+m.containerId+"_"+tobj.index).addClass("sc-selected"),m.outerDirection&&"across"==m.direction||!m.outerDirection&&(m.activeCell[0]>0&&-1!=m.state[m.activeCell[0]-1][m.activeCell[1]]||m.activeCell[0]<m.state.length-1&&-1!=m.state[m.activeCell[0]+1][m.activeCell[1]])){m.direction="across";for(i=0;i<tobj.word.length;i++)$("#cellinput_"+m.containerId+"_"+(tobj.x_pos+i)+"_"+tobj.y_pos).addClass("highlighted"),m.selectedWord.push(tobj.x_pos+i+"_"+tobj.y_pos)}else{m.direction="down";for(i=0;i<tobj.word.length;i++)$("#cellinput_"+m.containerId+"_"+tobj.x_pos+"_"+(tobj.y_pos+i)).addClass("highlighted"),m.selectedWord.push(tobj.x_pos+"_"+(tobj.y_pos+i))}m.selectedWord.index=tobj.index}m.outerDirection=!1,this.checkAnswer(),this.updateStatus()},checkAnswer:function(){for(var m=this.options.model,dirs=["across","down"],ii=0;ii<dirs.length;ii++)for(var i=0;i<m[dirs[ii]].length;i++){for(var isT=!0,t=0;t<m[dirs[ii]][i].word.length;t++){var dx=0,dy=0;"across"==dirs[ii]?dx=t:dy=t,$("#cellinput_"+m.containerId+"_"+(m[dirs[ii]][i].x_pos+dx)+"_"+(m[dirs[ii]][i].y_pos+dy)).removeClass("correct"),$("#cellinput_"+m.containerId+"_"+(m[dirs[ii]][i].x_pos+dx)+"_"+(m[dirs[ii]][i].y_pos+dy)).val()!=m[dirs[ii]][i].word[t]&&(isT=!1)}for(var tgtindex=-1,jj=0;jj<m.dictionary.indexes.length;jj++)if(m.dictionary.indexes[jj]==m[dirs[ii]][i].index+dirs[ii][0]){tgtindex=jj;break}m.pointsArr[tgtindex]=isT?1:0}var isCompleted=!0,currentScore=0;for(i=0;i<m.pointsArr.length;i++)if(1==m.pointsArr[i]){currentScore++;var obj=m.dictionary[m.dictionary.indexes[i]];for(t=0;t<obj.word.length;t++){dx=0,dy=0;"across"==obj.direction?dx=t:dy=t,$("#cellinput_"+m.containerId+"_"+(obj.x_pos+dx)+"_"+(obj.y_pos+dy)).addClass("correct")}}else isCompleted=!1;m.isFinished||(m.currentScore=currentScore,isCompleted&&this.completed())},getCellIdString:function(containerId,coords){return"#cellinput_"+containerId+"_"+coords[0]+"_"+coords[1]},getActiveCellElement:function(){var m=this.options.model;return $(this.getCellIdString(m.containerId,m.activeCell))},handleCellEvents:function(elem,useclick,usefocus){useclick&&$(elem).click(),usefocus&&$(elem).focus()},toNextCell:function(){var m=this.options.model;if("down"==m.direction){if(m.canMoveDown())m.moveInDirection(m.vectors.down);else if(m.canMoveRight())return m.direction="across",void this.toNextCell()}else if(m.canMoveRight())m.moveInDirection(m.vectors.right);else if(m.canMoveDown())return m.direction="down",void this.toNextCell();this.handleCellEvents(this.getActiveCellElement(),!1,!1),this.refreshView()},toPrevCell:function(){var m=this.options.model;if("down"==m.direction){if(m.canMoveUp())m.moveInDirection(m.vectors.up);else if(m.canMoveLeft())return m.direction="across",void this.toPrevCell()}else if(m.canMoveLeft())m.moveInDirection(m.vectors.left);else if(m.canMoveUp())return m.direction="down",void this.toPrevCell();this.handleCellEvents(this.getActiveCellElement(),!1,!1),this.refreshView()},updateStatus:function(){var m=this.options.model,pts=m.currentScore*(m.maxScore/m.pointsArr.length);pts=Math.round(10*pts)/10,$("#statusText_"+m.containerId).html(m.scoreText+" "+pts+"/"+m.maxScore)},setState:function(jsonObj){var m=this.options.model;this._super(jsonObj);for(var viewState=jsonObj.viewState,i=0;i<m.state.length;i++)for(var j=0;j<m.state[i].length;j++)-1!=m.state[i][j]&&$("#cellinput_"+m.containerId+"_"+i+"_"+j).val(viewState[i][j]);this.refreshView(),this.updateStatus()},getState:function(){for(var m=this.options.model,obj=m.getState(),viewState=new Array(m.state.length),i=0;i<m.state.length;i++){viewState[i]=new Array(m.state[i].length);for(var j=0;j<m.state[i].length;j++)-1!=m.state[i][j]&&""!=$("#cellinput_"+m.containerId+"_"+i+"_"+j).val()&&(viewState[i][j]=$("#cellinput_"+m.containerId+"_"+i+"_"+j).val())}return obj.viewState=viewState,obj}}),SCPTController("DidYouKnow",{},{init:function(){var m=this.options.model;this.scroll_w="ontouchstart"in document.documentElement?4:10;var question_w,answer_w,self=this,holder=$("#"+m.containerId).html("").addClass("sc-dyk-didyouknow").css({border:"1px solid "+getMixedColor("#3c3c3c",m.backgroundColor,.5),background:m.backgroundColor,height:m.height+"px",width:m.width+"px"}).append(this.options.template);holder.parents(get_greymatter_class_name()).defer_until_visible(function(){this.content_w=holder.width(),this.button=holder.find(".sc-dyk-show-answer .sc-dyk-button").html(m.button).click(this.show_answer.bind(this)),this.setup_image(1),this.setup_image(2);var question=holder.find(".sc-dyk-question > .sc-dyk-content");question_w=this.content_w-(parseInt(question.css("margin-left"))+parseInt(question.css("padding-left"))+parseInt(question.css("padding-right"))+parseInt(question.css("margin-right"))),question.css({"max-height":m.height/2-15+"px",width:question_w+"px"}).html(m.question),"ontouchstart"in document.documentElement&&question.niceScroll({cursorwidth:4});holder.height(),holder.find(".sc-dyk-question").outerHeight(!0);this.answer=holder.find(".sc-dyk-answer > .sc-dyk-content"),this.answer_img=holder.find(".sc-dyk-image-2").css({opacity:0}),answer_w=this.content_w-(parseInt(this.answer.css("margin-left"))+parseInt(this.answer.css("padding-left"))+parseInt(this.answer.css("padding-right"))+parseInt(this.answer.css("margin-right"))),this.answer.html(m.answer).css({"max-height":m.height/2-45+"px",width:answer_w+"px"}).bind("keydown",function(evt){self.key_handler.trigger(evt)});var answer_h=Math.max(50,this.answer.outerHeight(!0),this.button.outerHeight(!0))-(this.answer.outerHeight(!0)-this.answer.height());this.answer.css({height:answer_h+"px"}).hide(),this.key_handler=holder.find(".sc-dyk-key-handler").attr("id","inputf_"+m.params.containerId),this._super&&this._super()}.bind(this))},setup_image:function(i){var m=this.options.model;if(m["img_"+i]){var container=$("#"+m.containerId).find(".sc-dyk-image-"+i).children().first().addClass("sc-dyk-nonempty"),image=$(m["img_"+i]).removeAttr("width").removeAttr("height");this._adjust_image(container,image),container.append(image),this.content_w-=container.outerWidth(!0)}},_adjust_image:function(container,image){var img=new Image;img.src=image.attr("src");var max_h=container.height()||200,max_w=container.width()||150;img.onload=function(){var top="",left="";this.height>max_h&&(top="-"+(this.height-max_h)/2+"px"),this.width>max_w&&(left="-"+(this.width-max_w)/2+"px"),(left||top)&&image.css({position:"relative",left:left,top:top})}},show_answer:function(){this.button.hide(),this.answer.show(),this.answer_img.css({opacity:1}),"ontouchstart"in document.documentElement&&this.answer.niceScroll({cursorwidth:4})},hide_answer:function(){this.answer.hide(),this.button.show(),this.answer_img.css({opacity:0})},getState:function(jsonObj){return{show:this.answer.is(":visible")}},setState:function(jsonObj){return this[(jsonObj.show?"show":"hide")+"_answer"](),!0},handleKeys:function(e){var self=e.data.self;switch(e.keyCode){case 13:self.show_answer();break;default:return!0}e.preventDefault()},resetQuestion:function(){this.hide_answer()},disableActivity:function(){this._super()}}),SCPTController("DragNDrops",{},{init:function(){this.options.model.attempts++;var container=$("#"+this.options.model.containerId);this.options.model.randArrs=[],container.html(this.options.template,{labels:this.options.model.matchset,offsetTop:parseInt(container.offset().top,10),id:this.options.model.containerId,color:this.options.model.backgroundColor,width:this.options.model.width,height:this.options.model.height,randArr:this.options.model.returnRandomOrder(this.options.model.matchset.length),bigText:"true"==this.options.model.isBigText?"sc-bigText":""}),this._super()},revert:function(dragId){try{$("#"+this.options.model.getIdByIndex(dragId)).css({top:this.options.model.startCoords[dragId].y,left:this.options.model.startCoords[dragId].x})}catch(e){}},bindEvents:function(self){$("#"+self.options.model.containerId).find(".sc-dnd").bind("draginit",function(ev,drag){$(this).css("zIndex",1),self.options.model.fromKeyBoard||drag.revert()}).bind("mousedown",function(){$(this).css("zIndex",5)}).bind("mouseup",function(){$(this).css("zIndex",1)}).bind("dragend",function(ev,drag){$(drag).css("zIndex",1);var dragId=drag.delegate.getAttribute("data-id");self.options.model.pointsArr[dragId]<0&&self.revert(dragId)}),$("#"+self.options.model.containerId).find(".sc-dnd-dndTarget").each(function(index){$(this).bind("dropon",function(ev,drop,drag){var isTrue=0,dragId=drag.delegate.getAttribute("data-id"),dropId=drop.element[0].getAttribute("data-id");dragId==dropId&&(isTrue=1,drag.revert(!1),drag.position(new jQuery.Vector($(drop.element[0]).offset().left,$(drop.element[0]).offset().top)),$(drag.delegate).bind("draginit",function(ev,drag){drag.cancel()})),isTrue?(-2==self.options.model.pointsArr[dragId]&&(self.options.model.currentScore+=isTrue),self.options.model.pointsArr[dragId]=dropId):self.options.model.pointsArr[dragId]=-1,isTrue||(self.revert(dragId),$(drag.delegate).css("zIndex",1)),self.playIsCorrect(isTrue),self.updateStatus();for(var isCompleted=!0,i=0,l=self.options.model.pointsArr.length;i<l;i++)if(self.options.model.pointsArr[i]<0){isCompleted=!1;break}isCompleted&&self.completed()})}),$("#restart_"+this.options.model.containerId).bind("click",function(){self.reset()})},updateStatus:function(){var pts=this.options.model.currentScore*(this.options.model.maxScore/this.options.model.pointsArr.length);pts=Math.round(10*pts)/10,$("#statusText_"+this.options.model.containerId).html(this.options.model.scoreText+" "+pts+"/"+this.options.model.maxScore)},showAnswer:function(){for(var i=0,l=this.options.model.pointsArr.length;i<l;i++){var target=$("#dndTarget_"+this.options.model.containerId+"_"+i);$("#"+this.options.model.getIdByIndex(i)).css({left:target.css("left"),top:target.css("top")})}},setState:function(jsonObj){this._super(jsonObj),this.updateStatus();for(var i=0,l=this.options.model.pointsArr.length;i<l;i++)if(this.options.model.pointsArr[i]>-1){var target=$("#dndTarget_"+this.options.model.containerId+"_"+i);$("#"+this.options.model.getIdByIndex(i)).css({left:target.css("left"),top:target.css("top")})}}}),SCPTController("Hotspots",{},{init:function(){var self=this;self._super;this.options.model._ready?self._start.call(self):setTimeout(function(){self.init.call(self)},50)},_start:function(){var self=this,model=self.options.model;self.options.model.attempts++;var container=$("#"+model.containerId).removeClass("hotspots").addClass("sc-hp-hotspots");if(1==model.attempts){container.html(this.options.template,{offsetTop:parseInt(container.offset().top,10),id:model.containerId,color:model.backgroundColor,width:model.width,height:model.height,mode:model.mode}),container.find(".sc-hp-mainDiv").css({border:"1px solid "+getMixedColor("#3c3c3c",model.backgroundColor,.5)}),container.find(".sc-hp-skip").html(self.options.model.skipText),$("#restart_"+self.options.model.containerId).html(self.options.model.restartText),$("#finish_"+self.options.model.containerId).html(self.options.model.finishText);var img_wrapper=container.find(".sc-hp-workspace .sc-hp-wrapper"),p_top=parseInt(img_wrapper.css("padding-top"))||0,p_left=parseInt(img_wrapper.css("padding-left"))||0,p_right=parseInt(img_wrapper.css("padding-right"))||0,p_bottom=parseInt(img_wrapper.css("padding-bottom"))||0,max_w=(Math.max(model.workspace_p_h,p_top+model.workspace_i_h+p_bottom),Math.max(model.workspace_p_w,p_left+model.workspace_i_w+p_right)-p_left-p_right);img_wrapper.css({width:max_w+"px",height:model.workspace_i_h+"px"});var imgBack=model.imagebase64?"url('"+model.imagebase64+"')":"url("+model.image+")";self.image_paper=container.find(".sc-hp-workspace .sc-hp-wrapper .sc-hp-image").css({"background-image":imgBack,width:model.workspace_i_w+"px",height:model.workspace_i_h+"px"}),max_w>model.workspace_i_w&&self.image_paper.css({left:(max_w-model.workspace_i_w)/2+"px"});var rgb=getRGB("#"+model.backgroundColor);rgb=[(rgb[0]+256)/2,(rgb[1]+256)/2,(rgb[2]+256)/2];var question=container.find(".sc-hp-question").css({"background-color":"RGB("+parseInt(rgb[0])+", "+parseInt(rgb[1])+", "+parseInt(rgb[2])+")"});"true"==model.clue&&(question.find(".sc-hp-hint").show(),question.show()),"quiz"==model.mode&&(this.qstn_text=container.find(".sc-hp-questionText div").html(model.task[model.task.current].text),container.find(".sc-hp-add").css("height",Math.max(0,model.height-90-model.workspace_i_h-47-5)+"px")),this.next=this.qstn_skip=container.find(".sc-hp-button.sc-hp-skip").bind("complete",function(){$(this).addClass("sc-hp-complete"),self.responce.html("")}),this.qstn_hint=container.find(".sc-hp-button.sc-hp-hint").bind("complete",function(){$(this).addClass("sc-hp-complete")}).bind("click",function(){self.hint=!self.hint;var img=self.hint?model.cluebase64?model.cluebase64:model.image_clue:model.image;self.image_paper.css({"background-image":"url("+img+")"})}),"explore"==model.mode&&this.image_paper.append(model.tooltip),this.responce=container.find(".sc-hp-response").bind("correct",function(){$(this).css({color:"green"}).html(model.correctText)}).bind("incorrect",function(){$(this).css({color:"red"}).html(model.incorrectText)}).bind("reset",function(){$(this).css({color:"black"}).html("")}),this._bind[model.mode](model.image_paper,self),this._super(self)}this.qstn_hint.removeClass("sc-hp-complete"),this.qstn_skip.removeClass("sc-hp-complete"),this.qstn_skip.unbind("click").click(function(){model.task.currentIndex!=model.task.length-1?(model.task.current=model.returnRandomOrder.call(model,model.task.length)[++model.task.currentIndex],self.qstn_text.html(model.task[model.task.current].text)):(self.qstn_text.html(model.completedText),self.qstn_skip.trigger("complete"),self.qstn_hint.trigger("complete"),self.completed())})},bindEvents:function(self){$("#restart_"+this.options.model.containerId).bind("click",function(){self.reset(),self.options.model.task.currentIndex=-1,self.qstn_skip.click(),self.responce.trigger("reset")})},updateStatus:function(){var pts=this.options.model.currentScore*(this.options.model.maxScore/this.options.model.pointsArr.length);pts=Math.round(10*pts)/10||0,$("#statusText_"+this.options.model.containerId).html(this.options.model.scoreText+" "+pts+"/"+this.options.model.maxScore)},setState:function(jsonObj){this._super(jsonObj),this.updateStatus(),this.options.model.task.currentIndex=0;for(var i=0,l=this.options.model.pointsArr.length;i<l;i++){if(!(this.options.model.pointsArr[this.options.model.returnRandomOrder(this.options.model.task.length)[i]]>-1)){this.options.model.task.currentIndex=i,this.options.model.task.current=this.options.model.returnRandomOrder(this.options.model.task.length)[i];break}this.options.model.qstn_skip.click()}},handleKeys:function(e){},_bind:{quiz:function(image,self){self.image_paper.click(function(evt){var crds=self.options.model._get_coords(evt),color=self.options.model._get_image_data.call(image,crds,self.options.model);self.options.model.pointsArr[image.task.current]++,color==image.task[image.task.current].color?(0==self.options.model.pointsArr[image.task.current]&&self.options.model.currentScore++,self.responce.trigger("correct"),self.next.trigger("click"),self.playIsCorrect(!0),self.updateStatus()):(self.responce.trigger("incorrect"),self.playIsCorrect(!1))})},explore:function(image,self){var height=self.image_paper.height()/2,width=self.image_paper.width()/2;self.image_paper.bind("click mousemove",function(evt){var dx,dy,dh,dv,crds=self.options.model._get_coords(evt),color=self.options.model._get_image_data.call(image,crds,self.options.model),bubble=image.tooltip;"0"!=color?(color!=image.task[image.task.current].color&&image.task.find(color),crds.x<width?(dx=3,dh=!0):(dx=-bubble.w-3,dh=!1),crds.y<height?(dy=3,dv=!0):(dy=-bubble.h-3,dv=!1),bubble.content.html(image.task[image.task.current].text),9!=bubble._type&&bubble.css({left:crds.x+dx+"px",top:crds.y+dy+"px"}),bubble.update(dh,dv).show()):(bubble.hide(),$(this).css("cursor","default"))})}}}),SCPTController("Labelings",{},{init:function(){var self=this,m=this.options.model;m.attempts++;var container=$("#"+m.containerId),returnOrder=m.returnRandomOrder(m.labels.length);container.html(this.options.template,{img:m.img,imgPos:m.imgPosition,labels:m.labels,id:m.containerId,color:m.backgroundColor,width:m.width,height:m.height,randArr:returnOrder,bigText:"true"==m.isBigText?"sc-bigText":""}),m.rlcounter=0,container.parents(get_greymatter_class_name()).defer_until_visible(function(){self.resizeLabels(returnOrder)}),container.find(".sc-labelContainerDiv")[0].style.visibility="visible",this._super()},resizeLabels:function(returnOrder,drawLines){void 0===drawLines&&(drawLines=!0);for(var m=this.options.model,labels=m.labels,maxW=10,maxH=20,i=0;i<labels.length;i++){var obj=$("#"+m.getIdByIndex(i));maxW=Math.max(maxW,obj.width())}maxW=Math.floor(Math.min(maxW,262)),maxW+=2;for(i=0;i<labels.length;i++)$("#"+m.getIdByIndex(returnOrder[i])).css({width:maxW+"px",padding:"0"});for(i=0;i<labels.length;i++){obj=$("#"+m.getIdByIndex(i));if(maxH=Math.floor(Math.max(maxH,obj.height())),obj.height()<obj.find("div").height()&&1!=Math.abs(obj.height()-obj.find("div").height())&&m.rlcounter++<100)return void this.resizeLabels(returnOrder,!1)}var _css={width:maxW+"px",padding:"2px"};20==maxH?("true"===m.isBigText?(maxH-=4,_css.padding="2px"):(maxH-=8,_css.padding="4px 2px"),maxH+=2):maxH>22&&(_css.padding="0 0 2px 2px"),_css.height=maxH+"px";var dx=(m.width-maxW-10)/m.labels.length,dy=Math.min(4,(80-maxH)/m.labels.length);for(i=0;i<labels.length;i++)$("#"+m.getIdByIndex(returnOrder[i])).css({left:Math.floor(10+i*dx)+"px",top:Math.floor(dy*i+380)+"px"});for(i=0;i<labels.length;i++){obj=$("#"+m.getIdByIndex(i));var target=$("#labelTarget_"+m.containerId+"_"+i);target.css(_css),obj.css(_css),drawLines&&this.drawLine(obj,target,labels[i],maxW,maxH)}},drawLine:function(obj,target,label,maxW,maxH){var xy1=[label.dotx+$("#"+this.options.model.containerId).offset().left,label.doty+$("#"+this.options.model.containerId).offset().top],xy2=[target.offset().left,target.offset().top];xy1[0]<=xy2[0]+.33*maxW||(xy1[0]>=xy2[0]+.66*maxW?xy2[0]+=maxW:xy2[0]+=maxW/2),xy1[1]<=xy2[1]+.33*maxH||(xy1[1]>=xy2[1]+.66*maxH?xy2[1]+=maxH:xy2[1]+=maxH/2);var height=Math.abs(parseInt(-xy1[1]+xy2[1]))||1,width=Math.abs(parseInt(-xy1[0]+xy2[0])),lw=this.options.model.lineweight,ctx=$("<canvas width="+(width+2*lw)+" height="+(Math.abs(height)+2*lw)+"></canvas").css({position:"absolute",left:Math.min(xy1[0],xy2[0])-$("#"+this.options.model.containerId).offset().left-lw,top:Math.min(xy1[1],xy2[1])-$("#"+this.options.model.containerId).offset().top-lw}).appendTo($("#"+this.options.model.containerId).children()[0])[0].getContext("2d");ctx.strokeStyle=("#"+this.options.model.lineColor).replace("##","#"),ctx.lineWidth=lw,ctx.lineCap="round",ctx.beginPath(),xy1[1]>xy2[1]&&xy1[0]<xy2[0]||xy1[1]<xy2[1]&&xy1[0]>xy2[0]?(ctx.moveTo(lw,height+lw),ctx.lineTo(width+lw,lw)):(ctx.moveTo(lw,lw),ctx.lineTo(width+lw,height+lw)),ctx.stroke()},revert:function(dragId){try{$("#"+this.options.model.getIdByIndex(dragId)).css({top:this.options.model.startCoords[dragId].y,left:this.options.model.startCoords[dragId].x})}catch(e){}},bindEvents:function(self){$("#"+self.options.model.containerId).find(".sc-labels").bind("draginit",function(ev,drag){self.options.model.fromKeyBoard||drag.revert()}),$("#"+self.options.model.containerId).find(".sc-labelsTargets").each(function(index){$(this).bind("dropon",function(ev,drop,drag){console.info(123);var isTrue=0,dragId=drag.delegate.getAttribute("data-id"),dropId=drop.element[0].getAttribute("data-id");dragId==dropId&&(isTrue=1,drag.revert(!1),drag.position(new jQuery.Vector($(drop.element[0]).offset().left,$(drop.element[0]).offset().top)),$(drag.delegate).unbind().data("dropped","true")),isTrue?(-2==self.options.model.pointsArr[dragId]&&(self.options.model.currentScore+=isTrue),self.options.model.pointsArr[dragId]=dropId):self.options.model.pointsArr[dragId]=-1,isTrue||self.revert(dragId),self.playIsCorrect(isTrue),self.updateStatus();for(var isCompleted=!0,i=0,l=self.options.model.pointsArr.length;i<l;i++)if(self.options.model.pointsArr[i]<0){isCompleted=!1;break}isCompleted&&self.completed()})}),$("#restart_"+this.options.model.containerId).bind("click",function(){self.reset()})},updateStatus:function(){var pts=this.options.model.currentScore*(this.options.model.maxScore/this.options.model.pointsArr.length);pts=Math.round(10*pts)/10,$("#statusText_"+this.options.model.containerId).html(this.options.model.scoreText+" "+pts+"/"+this.options.model.maxScore)},showAnswer:function(){for(var i=0,l=this.options.model.pointsArr.length;i<l;i++){var target=$("#labelTarget_"+this.options.model.containerId+"_"+i);$("#"+this.options.model.getIdByIndex(i)).css({left:target.css("left"),top:target.css("top")})}},setState:function(jsonObj){this._super(jsonObj),this.updateStatus();for(var i=0,l=this.options.model.pointsArr.length;i<l;i++)if(this.options.model.pointsArr[i]>-1){var target=$("#labelTarget_"+this.options.model.containerId+"_"+i);$("#"+this.options.model.getIdByIndex(i)).css({left:target.css("left"),top:target.css("top")})}}}),SCPTController("Orderings",{},{init:function(){console.log("controller init");let model=this.options.model;this.options.model.attempts++,this.options.model.randArrs=[];var container=$("#"+model.containerId);let contents={labels:model.orderset,offsetTop:parseInt(container.offset().top,10),id:model.containerId,color:model.backgroundColor,width:model.width,height:model.height,randArr:model.returnRandomOrder(model.orderset.length),bigText:"true"==model.isBigText?"sc-bigText":""};container.html(this.options.template,contents),this._super()},revert:function(dragId){console.log("controller revert");try{$("#"+this.options.model.getIdByIndex(dragId)).css({top:this.options.model.startCoords[dragId].y,left:this.options.model.startCoords[dragId].x})}catch(e){}},bindEvents:function(self){console.log("controller bind"),scorder=$("#"+self.options.model.containerId).find(".sc-order"),console.log("scorder: "+scorder),$("#"+self.options.model.containerId).find(".sc-order").on("draginit",function(ev,drag){console.log("here we go!"),self.options.model.fromKeyBoard||drag.revert()}),scorder_target=$("#"+self.options.model.containerId).find(".sc-orderTarget"),console.log("scordertarget.length: "+scorder_target.length),$("#"+self.options.model.containerId).find(".sc-orderTarget").each(function(index){$(this).on("dropon",function(ev,drop,drag){console.log("chirp chirp");var isTrue=0,dragId=drag.delegate.getAttribute("data-id"),dropId=drop.element[0].getAttribute("data-id");console.log("--BIND EVENT STUFF--"),dragId==dropId&&(console.log("a"),isTrue=1,drag.revert(!1),console.log("b"),drag.position(new jQuery.Vector($(drop.element[0]).offset().left,$(drop.element[0]).offset().top)),console.log("c"),$(drag.delegate).on("draginit",function(ev,drag){console.log("d"),drag.cancel()})),isTrue?(console.log("e"),-2==self.options.model.pointsArr[dragId]&&(console.log("f"),self.options.model.currentScore+=isTrue),console.log("g"),self.options.model.pointsArr[dragId]=dropId,console.log("h")):(console.log("i"),self.options.model.pointsArr[dragId]=-1,console.log("j")),isTrue||(console.log("k"),self.revert(dragId),console.log("l")),console.log("m"),self.playIsCorrect(isTrue),console.log("n"),self.updateStatus(),console.log("o");var isCompleted=!0;console.log("p");for(var i=0,l=self.options.model.pointsArr.length;i<l;i++)if(self.options.model.pointsArr[i]<0){isCompleted=!1;break}console.log("q"),isCompleted&&(console.log("r"),self.completed(),console.log("s")),console.log("t"),console.log("--BIND EVENT STUFF--")})}),$("#restart_"+this.options.model.containerId).on("click",function(){self.reset()})},updateStatus:function(){console.log("controller update");let model=this.options.model,actualpts=model.currentScore*(model.maxScore/model.pointsArr.length);var pts=Math.round(10*actualpts)/10;$("#statusText_"+model.containerId).html(model.scoreText+" "+pts+"/"+model.maxScore)},showAnswer:function(){console.log("controller show");for(var i=0,l=this.options.model.pointsArr.length;i<l;i++){var target=$("#orderTarget_"+this.options.model.containerId+"_"+i);$("#"+this.options.model.getIdByIndex(i)).css({left:target.css("left"),top:target.css("top")})}},setState:function(jsonObj){console.log("controller set");let model=this.options.model;this._super(jsonObj),this.updateStatus();for(var i=0,l=model.pointsArr.length;i<l;i++)if(model.pointsArr[i]>-1){var target=$("#orderTarget_"+model.containerId+"_"+i);$("#"+model.getIdByIndex(i)).css({left:target.css("left"),top:target.css("top")})}}}),SCPTController("PhotoAlbum",{},{init:function(){var self=this;this.options.model._ready?(this.holder=$("#"+this.options.model.params.containerId).addClass("sc-pa-photoalbum").css({background:this.options.model.bgcolor,border:"1px solid "+getMixedColor("#3c3c3c",this.options.model.bgcolor,.5)}).append(this.options.template),this.view={page:self.holder.find(".sc-pa-page").fadeOut(0),img:self.holder.find(".sc-pa-img"),des:self.holder.find(".sc-pa-des"),num:self.holder.find(".sc-pa-num"),prev:self.holder.find(".sc-pa-prev"),next:self.holder.find(".sc-pa-next")},this.album=self.options.model.photo,this.current=self.options.model.current,this._set_page(),this._get_frame(0).show(),this.animation=null,this.frames=25,this.frame=1,this.view.next.click(function(){self.next()}),this.view.prev.click(function(){self.prev()}),this.holder.find(".sc-pa-key-handler").attr("id","inputf_"+this.options.model.params.containerId),this.holder.find(".sc-pa-des").css("text-align",self.options.model.textAlign),this._super()):setTimeout(function(){self.init()},50)},_set_page:function(){this.view.img.html('<img src="'+this.album[this.current].url+'" style="width: '+this.album[this.current].w+"px; height: "+this.album[this.current].h+'px"/>'),this.view.des.html(this.album[this.current].caption),this.view.num.html(this.current+1+" / "+this.album.length),this.view.page.fadeIn("slow")},prev:function(){this.animation||(this.view.page.fadeOut(100),0==this.current?this.current=this.album.length-1:this.current--,this._prev_animate())},next:function(){this.animation||(this.view.page.fadeOut(100),this.current==this.album.length-1?this.current=0:this.current++,this._next_animate())},_get_frame:function(n){return this.holder.find(n<10?".0"+n:"."+n)},_prev_frame:function(){this._get_frame(this.frame).hide(),1==this.frame?(this.animation&&(clearInterval(this.animation),this.animation=null,this._set_page()),this.frame=this.frames):this.frame--,this._get_frame(this.frame).show()},_next_frame:function(){this._get_frame(this.frame).hide(),this.frame==this.frames?(this.animation&&(clearInterval(this.animation),this.animation=null,this._set_page()),this.frame=1):this.frame++,this._get_frame(this.frame).show()},_prev_animate:function(){1==this.frame&&(this.frame=this.frames);var self=this;this.animation=setInterval(function(){self._prev_frame()},50)},_next_animate:function(){this.frame==this.frames&&(this.frame=1);var self=this;this.animation=setInterval(function(){self._next_frame()},50)},getState:function(jsonObj){return{page:this.current}},setState:function(jsonObj){this.current=parseInt(jsonObj.page),this._set_page()},handleKeys:function(e){var self=e.data.self;switch(e.keyCode){case 37:self.prev();break;case 39:self.next();break;default:return!0}e.preventDefault()},reset:function(){},disableActivity:function(){this._super()}}),SCPTController("Puzzles",{},{init:function(){var self=this,k$=Kinetic,container=$("#"+this.options.model.containerId);container.html(this.options.template,{offsetTop:parseInt(container.offset().top,10),id:this.options.model.containerId,color:this.options.model.backgroundColor,width:this.options.model.width,height:this.options.model.height}),$("#restart_"+self.options.model.containerId).html(self.options.model.restartText),$("#finish_"+self.options.model.containerId).html(self.options.model.finishText),$("#puzzle_container_"+this.options.model.containerId).append(this.options.model.holder.append(this.options.model.canbox,this.options.model.w_load)),this.stage=new k$.Stage(this.options.model.cnv_id,710,360,{dragDebounce:!0}),this.board=new k$.Layer,this.chips=new k$.Layer,this.frame=new k$.Shape(function(){var ctx=this.getContext();ctx.save(),ctx.rect(5,self.options.model.toph,self.options.model.wwidth,self.options.model.hheight),ctx.lineWidth=4,ctx.strokeStyle="black",ctx.shadowColor="#3c3c3c",ctx.shadowBlur=5,ctx.shadowOffsetX=0,ctx.shadowOffsetY=0,ctx.fillStyle="white",ctx.stroke(),ctx.fill(),ctx.restore(),this.sx=5,this.sy=self.options.model.toph},"board"),this.board.add(this.frame),this.stage.add(this.board),this.stage.add(this.chips),this.board.draw(),this.options.model.pieces.layer=this.chips,this.options.model.pieces.current=0,this.drawPuzzle(),this._super()},drawPuzzle:function(){var self=this,k$=Kinetic,n=Math.max(this.options.model.cols,this.options.model.rows)/2,a=Math.round(100/n)/4,b=Math.round(50/n)/4,b2=Math.round(2*b),p_prm=[],p_path=[],bound=[];this.options.model.pieces.l=a;for(var c=0;c<this.options.model.cols;c++){p_prm[c]=[];for(var r=0;r<this.options.model.rows;r++){var o_O=p_prm[c][r]={};if(c!=this.options.model.cols-1){var s=2*Math.round(Math.random())-1,d=Math.round(Math.random()*this.options.model.pieces.h/4+this.options.model.pieces.h/4),w=Math.round(a*s);bound.push(["m",c*this.options.model.pieces.w+this.options.model.pieces.w,r*this.options.model.pieces.h],["l",0,d],["q",w,-b,w,b],["q",0,b2,-w,b],["l",0,this.options.model.pieces.h-b2-d]),o_O.v={d:d,w:w}}if(r!=this.options.model.rows-1){s=2*Math.round(Math.random())-1,d=Math.round(Math.random()*this.options.model.pieces.w/4+this.options.model.pieces.w/4),w=Math.round(a*s);bound.push(["m",c*this.options.model.pieces.w+this.options.model.pieces.w,r*this.options.model.pieces.h+this.options.model.pieces.h],["l",-d,0],["q",b,w,-b,w],["q",-b2,0,-b,-w],["l",-this.options.model.pieces.w+b2+d,0]),o_O.h={d:d,w:w}}}}this.board.add(new k$.Shape(this._make_shape(bound,self))),this.target=new k$.Shape(this._make_target(self)),this.target_xmax=this.options.model.cols-1,this.target_ymax=this.options.model.rows-1,this.target_x=0,this.target_y=0,this.board.add(this.target);for(c=0;c<this.options.model.cols;c++)for(r=0;r<this.options.model.rows;r++){var dx=0,dy=0;(p_path=[]).push(["m",c*this.options.model.pieces.w,r*this.options.model.pieces.h]),0==r?p_path.push(["l",this.options.model.pieces.w,0]):(d=p_prm[c][r-1].h.d,w=p_prm[c][r-1].h.w,dy=Math.min(dy,w),p_path.push(["l",this.options.model.pieces.w-b2-d,0],["q",-b,w,b,w],["q",b2,0,b,-w],["l",d,0])),c==this.options.model.cols-1?p_path.push(["l",0,this.options.model.pieces.h]):(d=p_prm[c][r].v.d,w=p_prm[c][r].v.w,p_path.push(["l",0,d],["q",w,-b,w,b],["q",0,b2,-w,b],["l",0,this.options.model.pieces.h-b2-d])),r==this.options.model.rows-1?p_path.push(["l",-this.options.model.pieces.w,0]):(d=p_prm[c][r].h.d,w=p_prm[c][r].h.w,p_path.push(["l",-d,0],["q",b,w,-b,w],["q",-b2,0,-b,-w],["l",-this.options.model.pieces.w+b2+d,0])),0==c?p_path.push(["l",0,-this.options.model.pieces.h]):(d=p_prm[c-1][r].v.d,w=p_prm[c-1][r].v.w,dx=Math.min(dx,w),p_path.push(["l",0,-this.options.model.pieces.h+b2+d],["q",w,b,w,-b],["q",0,-b2,-w,-b],["l",0,-d])),this.options.model.pieces.push({path:p_path,shape:null,ox:c*this.options.model.pieces.w,oy:r*this.options.model.pieces.h})}this.img=new Image,this.img.onload=function(){for(var arr=[],i=self.options.model.pieces.length;i--;)arr.push(i);self.shuffle(arr),self.options.model.arr=arr;for(i=self.options.model.pieces.length;i--;){var pci=self.options.model.pieces[arr[i]],obj=pci.shape=new k$.Shape(self._make_piece(pci,self.img,self));pci.highlight=!1,obj.draggable(!0),obj.model=self.options.model.pieces,obj.on("mouseover",function(){self.options.model.canbox.css("cursor","pointer")}),obj.on("mouseout",function(){self.options.model.canbox.css("cursor","default")}),obj.on("mousedown touchstart",function(i){return function(){var c=self.options.model.pieces.current;i=self.options.model.arr[i],self.options.model.pieces[c].highlight=!1,self.options.model.pieces[i].highlight=!0,self.options.model.pieces.current=i,this.moveToTop(),this.parent.draw()}}(i)),obj.on("mouseup touchend",function(){this._check(self)}),self.chips.add(obj),self.chips.draw()}self.options.model.reset(),self.options.model.w_load.remove(),self.imageFinish=$(self.img).appendTo($("#"+self.options.model.containerId).find(".sc-pz-puzzleCanBox")).css({width:self.options.model.wwidth+"px",height:self.options.model.hheight+"px",top:self.options.model.toph+0+"px",left:"5px",position:"absolute"}).hide()},k$.Shape.prototype._check=function(self){if(!this._right){var crds=this.getPosition();Math.abs(crds.x)<this.model.w/8&&Math.abs(crds.y)<this.model.h/8?(this._right=!0,this.setPosition(0,0),this.draggable(!1),this.parent.draw(),self.options.model.tcurrentScore++,self.updateStatus()):this._right=!1}},this.img.src=this.options.model.image,this.board.draw()},_make_target:function(self){var arr,ind,sy=self.options.model.toph,ox=5,oy=sy,cx=0,cy=0,pieces=self.options.model.pieces;return function(){if(self.target_x>-1&&self.target_y>-1){var ctx=this.getContext();ind=self.target_x*(self.target_ymax+1)+self.target_y,arr=pieces[ind].path,ctx.save(),ctx.beginPath(),ctx.lineWidth=0,ctx.fillStyle="#ffda6b";for(var i=0,l=arr.length;i<l;i++)"m"==arr[i][0]&&(ox=5,oy=sy),cx=ox+arr[i][3],cy=oy+arr[i][4],ox+=arr[i][1],oy+=arr[i][2],ctx[self._canvas_map[arr[i][0]]](ox,oy,cx,cy),ox=isNaN(cx)?ox:cx,oy=isNaN(cy)?oy:cy;ctx.closePath(),ctx.fill(),ctx.restore()}}},_make_piece:function(pci,img,self){var sy=self.options.model.toph,arr=pci.path;return function(){this.parent.getChild("board");var ox=5,oy=sy,cx=0,cy=0,ctx=this.getContext();ctx.restore(),ctx.save(),ctx.beginPath(),ctx.lineWidth=1,ctx.strokeStyle=pci.highlight?"orange":"black",ctx.shadowColor="#3c3c3c",ctx.shadowBlur=0;for(var i=0,l=arr.length;i<l;i++)"m"==arr[i][0]&&(ox=5,oy=sy),cx=ox+arr[i][3],cy=oy+arr[i][4],ox+=arr[i][1],oy+=arr[i][2],ctx[self._canvas_map[arr[i][0]]](ox,oy,cx,cy),ox=isNaN(cx)?ox:cx,oy=isNaN(cy)?oy:cy;ctx.closePath(),ctx.clip();var width_ratio=self.options.model.wwidth/img.width,height_ratio=self.options.model.hheight/img.height;ctx.scale(width_ratio,height_ratio),ctx.fillStyle=ctx.createPattern(img,"no-repeat"),ctx.translate(5/width_ratio,sy/height_ratio),ctx.fill(),ctx.restore(),ctx.save(),ctx.strokeStyle=pci.highlight?"orange":"black",ctx.stroke(),ctx.restore()}},_make_shape:function(arr,self){self=this;return function(){var brd=this.parent.getChild("board"),ox=brd.sx,oy=brd.sy,cx=0,cy=0,ctx=this.getContext();ctx.save(),ctx.beginPath(),ctx.lineWidth=1,ctx.lineCap="butt",ctx.lineJoin="round",ctx.strokeStyle="black";for(var i=0,l=arr.length;i<l;i++)"m"==arr[i][0]&&(ox=brd.sx,oy=brd.sy),cx=ox+arr[i][3],cy=oy+arr[i][4],ox+=arr[i][1],oy+=arr[i][2],ctx[self._canvas_map[arr[i][0]]](ox,oy,cx,cy),ox=isNaN(cx)?ox:cx,oy=isNaN(cy)?oy:cy;ctx.stroke(),ctx.closePath(),ctx.restore()}},_canvas_map:{m:"moveTo",l:"lineTo",q:"quadraticCurveTo"},move:function(){var m=this.options.model;if(-1!=m.pieces.current&&!m.pieces[m.arr[m.pieces.current]].shape._right){var pieces=m.pieces,tind=this.target_x*(this.target_ymax+1)+this.target_y,cind=m.arr[m.pieces.current],crds={x:pieces[tind].path[0][1]-pieces[cind].path[0][1],y:pieces[tind].path[0][2]-pieces[cind].path[0][2]};pieces[cind].shape.setPosition(crds.x,crds.y),pieces[cind].shape._check(this),pieces.layer.draw()}},target_move:function(x,y){this.target_x+=x,this.target_y+=y,this.target_x>this.target_xmax&&(this.target_x=0),this.target_y>this.target_ymax&&(this.target_y=0),this.target_x<0&&(this.target_x=this.target_xmax),this.target_y<0&&(this.target_y=this.target_ymax),this.board.draw()},bindEvents:function(self){$("#restart_"+this.options.model.containerId).bind("click",function(){self.reset()}),$("#finish_"+this.options.model.containerId).bind("click",function(self){return function(){for(var i=0;i<self.options.model.pieces.length;i++){var pcs=self.options.model.pieces[i].shape;self.imageFinish.show(),pcs._right=!0,pcs.setPosition(0,0),pcs.draggable(!1),pcs.parent.draw(),self.playIsCorrect(!0)}self.completed()}}(this))},updateScore:function(score){if(void 0!==score){var pts=score;score>0&&$("#statusText_"+this.options.model.containerId).html(this.options.model.scoreText+" "+pts+"/"+this.options.model.maxScore)}},updateStatus:function(){var pts=this.options.model.tcurrentScore*(this.options.model.maxScore/this.options.model.pieces.length);pts=Math.round(10*pts)/10,this.options.model.currentScore=pts,this.options.model.tcurrentScore==this.options.model.pieces.length&&(this.imageFinish.show(),this.playIsCorrect(!0),this.completed(),this.options.model.unhighlight()),$("#statusText_"+this.options.model.containerId).html(this.options.model.scoreText+" "+pts+"/"+this.options.model.maxScore)},setState:function(jsonObj){this.options.model.setState(jsonObj),this.updateStatus(),this.updateScore(jsonObj.curScore)},handleKeys:function(e){var self=e.data.self;if(e.altKey)switch(e.keyCode){case 85:return e.data.self.reset(!1),!1;case 81:$("#finish_"+self.options.model.containerId).click();break;default:return!0}else switch(e.keyCode){case 32:e.ctrlKey||self.options.model.next();break;case 13:self.move();break;case 37:self.target_move(-1,0);break;case 38:self.target_move(0,-1);break;case 39:self.target_move(1,0);break;case 40:self.target_move(0,1);break;default:return!0}e.preventDefault()},reset:function(){this.imageFinish&&this.imageFinish.hide(),this.options.model.reinit(),this.options.model.reset();for(var i=this.options.model.pieces.length;i--;)this.options.model.pieces[i].shape._right=!1;this._super(!0),this.updateStatus()},disableActivity:function(){this._super();for(var i=0;i<this.options.model.pieces.length;i++){this.options.model.pieces[i].shape.draggable(!1)}},shuffle:function(o){for(var j,x,i=o.length;i;j=parseInt(Math.random()*i),x=o[--i],o[i]=o[j],o[j]=x);return o}}),SCPTController("SectionedShape",{},{init:function(){this.touch=!!("ontouchstart"in document.documentElement),this.scroll_w=this.touch?4:10;var holder=$("#"+this.options.model.containerId).html("").addClass("sc-chart-sectionedshape").css({border:"1px solid "+getMixedColor("#3c3c3c",this.options.model.backgroundColor,.5),background:this.options.model.backgroundColor}).append(this.options.template);this.marker=holder.find(".sc-chart-marker"),this.active=null,this.title=holder.find(".sc-chart-title").html(this.options.model.title),this.descr=holder.find(".sc-chart-descr").html(this.options.model.descr),this.alttext=holder.find(".sc-chart-alttext"),this.alttext.offset=holder.offset(),this._adjust_labels(holder,this.options.model.section),this.section=this._build_sections(holder,this.options.model.section),this.touch||(holder.bind("mousemove",function(self){return function(evt){self._save_mouse_coords(evt)}}(this)),this.alttext.insertAfter(holder.find(".sc-chart-paper"))),this.descr.parent().niceScroll({cursorwidth:this.scroll_w}),this.descr.parents(get_greymatter_class_name()).bind("isVisible",function(){this.descr.parent().getNiceScroll().each(function(){this.updateScrollBar()}),this.descr.parent().getNiceScroll().show()}.bind(this)),this.descr.parents(get_greymatter_class_name()).bind("isHidden",function(){this.descr.parent().getNiceScroll().hide()}.bind(this));holder.find(".sc-chart-key-handler").attr("id","inputf_"+this.options.model.params.containerId);this._super()},_adjust_labels:function(cnt,arr){for(var str,c_w,r_w,test_box=$('<div class="sc-chart-label">sds</div>').css({position:"absolute",top:"0px",left:"0px",border:"0",padding:"0",margin:"0"}).appendTo(cnt).fadeOut(0),s=arr.length;s--;)for(var c=arr[s].subsection.length;c--;){for(str=arr[s].subsection[c].showTitle?arr[s].subsection[c].title:"",c_w=test_box.html(str).width(),r_w=arr[s].subsection[c].path_text_width;c_w>r_w&&""!=str;)str=str.slice(0,-1),c_w=test_box.html("&nbsp;"+str+"...&nbsp;").width();arr[s].subsection[c].title!=str&&""!=str?arr[s].subsection[c].label=str+"...":arr[s].subsection[c].label=str}test_box.remove()},_build_sections:function(cnt,arr){for(var shape,tr=this.options.model.t[this.options.model.type],defs="",shapes="",section=[],s=arr.length;s--;)for(var c=arr[s].subsection.length;c--;)shapes+='<g transform="matrix(1 0 0 1 0 0)" opacity="0.5" shape="'+s+"-"+c+'"><path d="'+(shape=arr[s].subsection[c]).path_shape+'" stroke="#3c3c3c" fill-opacity="0.5" stroke-width="1" fill="'+shape.color+'"/><text class="sc-chart-label"><textpath xlink:href="#path-'+this.options.model.containerId+"-"+s+"-"+c+'" text-anchor="middle" startOffset="50%" alignment-baseline="middle">'+shape.label+"</textpath></text></g>",defs+='<path id="path-'+this.options.model.containerId+"-"+s+"-"+c+'" d="'+shape.path_text+'"/>';cnt.append('<svg class="sc-chart-paper" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="370px" height="450px"><defs>'+defs+'</defs><g class="sc-chart-chart" transform="matrix(1 0 0 1 '+tr.join(" ")+')">'+shapes+"</g></svg>");for(s=arr.length;s--;){section[s]=[];for(c=arr[s].subsection.length;c--;)shape=cnt.find("[shape="+s+"-"+c+"]").bind("click",function(self,n,s){return function(){self.show_section(n,s)}}(this,s,c)),this.touch||shape.bind("mouseover",function(self,n,s){return function(){self.move_section_frwd(n,s)}}(this,s,c)).bind("mouseout",function(self,n,s){return function(){self.move_section_back(n,s)}}(this,s,c)),shape.marker=arr[s].subsection[c].marker,shape.title=arr[s].subsection[c].title,shape.showTitle=arr[s].subsection[c].showTitle,shape.descr=arr[s].subsection[c].descr,shape.dx=arr[s].subsection[c].dx,shape.dy=arr[s].subsection[c].dy,shape.cx=0,shape.cy=0,section[s].unshift(shape)}return section},_move_marker_to:function(top){this.marker.stop().animate({top:top+"px"})},_save_mouse_coords:function(evt){this.alttext.offset=$("#"+this.options.model.containerId).offset(),this.alttext.x=evt.pageX-this.alttext.offset.left-10,this.alttext.y=evt.pageY-this.alttext.offset.top-10},show_alttext:function(n,s){this.alttext.html(this.section[n][s].title).css({left:this.alttext.x+"px",top:this.alttext.y-this.alttext.outerHeight(!0)+"px"}).show().fadeIn(100)},hide_alttext:function(){this.alttext.html("").fadeOut(100).hide().css({left:"-50px",top:"-50px"})},show_section:function(n,s){this.active&&this.active.attr("opacity",.5),this.active=this.section[n][s],this._move_marker_to(this.active.marker),this.active.attr("opacity",1),this.title.html(this.active.title),this.descr.parent().getNiceScroll().remove(),this.descr.html(this.active.descr),this.descr.parent().niceScroll({cursorwidth:this.scroll_w}),this.move_section_back(n,s)},move_section_frwd:function(n,s){var o=this.section[n][s],x=o.dx>0?1:-1,y=o.dy>0?1:-1;clearTimeout(o.anim);var post_anim=function(self,n,s){return function(){self.show_alttext(n,s)}}(this,n,s),anim=function(){o.cx!=o.dx||o.cy!=o.dy?(o.cx!=o.dx&&(o.cx+=x),o.cy!=o.dy&&(o.cy+=y),o.attr({transform:"matrix(1 0 0 1 "+o.cx+" "+o.cy+")"}),o.anim=setTimeout(function(){anim()},15)):post_anim()};anim()},move_section_back:function(n,s){var o=this.section[n][s],x=o.dx>0?-1:1,y=o.dy>0?-1:1;clearTimeout(o.anim);var self,anim=function(){0==o.cx&&0==o.cy||(0!=o.cx&&(o.cx+=x),0!=o.cy&&(o.cy+=y),o.attr({transform:"matrix(1 0 0 1 "+o.cx+" "+o.cy+")"}),o.anim=setTimeout(function(){anim()},15))};anim(),setTimeout((self=this,function(){self.hide_alttext(n,s)}),100)},prev_section:function(){if(this.active){var state=this.active.attr("shape").split("-"),s=+state[0],c=+state[1];s=0==s?this.section.length-1:s-1,c=c<=this.section[s].length-1?c:0}else s=this.section.length-1,c=0;this.show_section(s,c)},next_section:function(){if(this.active){var state=this.active.attr("shape").split("-"),s=+state[0],c=+state[1];s=s==this.section.length-1?0:s+1,c=c<=this.section[s].length-1?c:0}else s=0,c=0;this.show_section(s,c)},prev_chart:function(){if(this.active){var state=this.active.attr("shape").split("-"),s=+state[0],c=+state[1];c=0==c?this.section[s].length-1:c-1}else s=this.section.length-1,c=0;this.show_section(s,c)},next_chart:function(){if(this.active){var state=this.active.attr("shape").split("-"),s=+state[0],c=+state[1];c=c==this.section[s].length-1?0:c+1}else s=this.section.length-1,c=0;this.show_section(s,c)},getState:function(jsonObj){return this.active?{chart:this.active.attr("shape")}:{chart:"no"}},setState:function(jsonObj){var state=jsonObj.chart.split("-");return state[0]&&state[1]&&this.show_section(parseInt(state[0]),parseInt(state[1])),!0},handleKeys:function(e){var self=e.data.self,n1="circle"==self.options.model.type?"next_":"prev_",n2="circle"==self.options.model.type?"prev_":"next_",m1="circle"==self.options.model.type?"chart":"section",m2="circle"==self.options.model.type?"section":"chart";switch(e.keyCode){case 38:self[n1+m1]();break;case 37:self["prev_"+m2]();break;case 39:self["next_"+m2]();break;case 40:self[n2+m1]();break;default:return!0}e.preventDefault()},resetQuestion:function(){},disableActivity:function(){this._super()}}),SCPTController("SeekAWords",{},{init:function(){var m=this.options.model;m.attempts++,$("#"+m.containerId).html(this.options.template,{id:m.containerId,color:m.backgroundColor,width:m.width,height:m.height,maxScore:m.maxScore,state:m.state,inst:m.instructions,sheetSize:m.sheetSize,isHint:m.isHint}),m.draw=$("#seekAWord_Paper_"+m.containerId),m.table=$("#seekAWord_Table_"+m.containerId),this.initDrawing(),this._super()},bindEvents:function(self){self=this;var m=this.options.model;if(m.isHint)for(var i=0;i<m.state.answer_key.length;i++)$("#word_"+i+"_"+m.containerId).bind("click",function(index){return function(){self.showHint(index)}}(i)).css({cursor:"pointer"});$("#restart_"+m.containerId).bind("click",function(){self.reset()}),$("#finish_"+m.containerId).bind("click",function(){self.showAnswer(),self.completed()}),$("#inputf_"+m.containerId).bind("keypress",function(evt){var kc=evt.keyCode;(32==kc||kc>=37&&kc<=40)&&evt.preventDefault()})},initDrawing:function(){var self=this,m=this.options.model,tpaper=Raphael("seekAWord_Paper_"+m.containerId,400,400);m.paper=Raphael("seekAWord_BackPaper_"+m.containerId,400,400),tpaper.draw=tpaper.rect(0,0,400,400).attr({"stroke-width":0,fill:"white","fill-opacity":0,opacity:0,cursor:"pointer"}),tpaper.draw.drag(function(dx,dy,x,y){self.moveLine(x,y,self)},function(x,y){self.startLine(x,y,self)},function(){self.endLine(self)})},startLine:function(x,y,self){var m=self.options.model;m.line.line=m.paper.path("M0,0L0,0").attr({"stroke-width":"10pt",stroke:"#9dbdff","stroke-linecap":"round",opacity:1});var _obj=self.snapLine(x,y,!1);m.line.x[0]=_obj.x,m.line.y[0]=_obj.y,m.line.x[1]=_obj.x,m.line.y[1]=_obj.y,self.updatePaperState()},moveLine:function(x,y,self){var m=self.options.model,_obj=self.snapLine(x,y,!0);m.line.x[1]=_obj.x+1,m.line.y[1]=_obj.y+2,self.updatePaperState()},endLine:function(self){var m=self.options.model;m.line.cells[2]||(m.line.cells[2]=m.line.cells[0]),self.updatePaperState(),self.checkLine()},updatePaperState:function(){var self=this.options.model,offsetX=self.draw.offset().left,offsetY=self.draw.offset().top,_p=["M",self.line.x[0]-offsetX,self.line.y[0]-offsetY,"L",self.line.x[1]-offsetX,self.line.y[1]-offsetY];self.line.line.attr({path:_p}).show()},checkLine:function(){var m=this.options.model,isCorrect=!1;void 0===m.state.answer_key&&(m.state.answer_key=m.seekAWordSheet.answer_key);for(var i=0;i<m.state.answer_key.length;i++){var obj=m.state.answer_key[i];obj.start;if(obj.start.j+1==m.line.cells[2][1]&&obj.start.k+1==m.line.cells[2][0]){var t=[m.line.cells[2][0],m.line.cells[2][1]];m.line.cells[2][0]=m.line.cells[0][0],m.line.cells[2][1]=m.line.cells[0][1],m.line.cells[0][0]=t[0],m.line.cells[0][1]=t[1]}if(obj.start.j+1==m.line.cells[0][1]&&obj.start.k+1==m.line.cells[0][0]){var end_point=[obj.start.k+1+(obj.word.length-1)*obj.increments.k,obj.start.j+1+(obj.word.length-1)*obj.increments.j];if(m.line.cells[2][0]==end_point[0]&&m.line.cells[2][1]==end_point[1]){m.pointsArr[i]=1,isCorrect=!0,$("#word_"+i+"_"+m.containerId).unbind().find("hr").show();break}}}isCorrect||m.line.line.remove(),this.updateStatus(),this.playIsCorrect(isCorrect)},snapLine:function(x,y,isFinish){for(var m=this.options.model,offset=m.table.find("tr:nth-child(1)").find("td:nth-child(1)").offset(),dxy=[x-(offset=[offset.left,offset.top])[0],y-offset[1]],i=0;i<dxy.length;i++)dxy[i]<m.cellSize/2?dxy[i]=m.cellSize/2:dxy[i]>(m.size-.5)*m.cellSize&&(dxy[i]=(m.size-.5)*m.cellSize);var cell=[Math.round(dxy[0]/m.cellSize-.5)+1,Math.round(dxy[1]/m.cellSize-.5)+1];isFinish?(m.line.cells[1]=cell,m.line.cells[2]=this.getClosestLetter(),cell=m.line.cells[2]):m.line.cells[0]=cell;var xy=this.returnXYByCell(cell[1],cell[0]);return{x:Math.floor(xy[0]),y:Math.floor(xy[1])}},returnXYByCell:function(i,j){var m=this.options.model,off=m.table.find("tr:nth-child("+i+")").find("td:nth-child("+j+")").offset();return[off.left+m.cellSize/2-2,off.top+m.cellSize/2-3]},getClosestLetter:function(){var _loc2,_loc3,m=this.options.model,_loc6=m.line.cells[0][0],_loc4=m.line.cells[0][1],_loc5=m.line.cells[1][0],_loc7=m.line.cells[1][1];if(1==Math.abs((_loc6-_loc5)/(_loc4-_loc7))||0==Math.abs(_loc6-_loc5)||0==Math.abs(_loc4-_loc7))_loc2=_loc5,_loc3=_loc7;else{var _loc8=Math.abs(180*Math.atan2(_loc5-_loc6,_loc7-_loc4)/3.141593);_loc8<22.5||_loc8>157.5?(_loc2=_loc6,_loc3=_loc7):_loc8>67.5&&_loc8<112.5?(_loc2=_loc5,_loc3=_loc4):(_loc2=Math.max(Math.abs(_loc5-_loc6),Math.abs(_loc7-_loc4))*this.sign(_loc5-_loc6)+_loc6,_loc3=Math.max(Math.abs(_loc5-_loc6),Math.abs(_loc7-_loc4))*this.sign(_loc7-_loc4)+_loc4)}return _loc2=Math.max(1,_loc2),_loc3=Math.max(1,_loc3),[_loc2=Math.min(m.size,_loc2),_loc3=Math.min(m.size,_loc3)]},sign:function(val){return 0==val?0:val/Math.abs(val)},showHint:function(index){var start=this.options.model.state.answer_key[index].start,xy=this.returnXYByCell(start.j+1,start.k+1),offset=this.options.model.draw.offset();xy=[xy[0]-offset.left,xy[1]-offset.top],this.options.model.paper.path("M"+xy[0]+","+xy[1]+"L"+xy[0]+","+(xy[1]+1)).attr({"stroke-width":"10pt",stroke:"#9dbdff","stroke-linecap":"round",opacity:1})},showAnswer:function(){for(var i=0;i<this.options.model.state.answer_key.length;i++)this.showSingleAnswer(i)},showSingleAnswer:function(i){var m=this.options.model,offset=this.options.model.draw.offset(),obj=m.seekAWordSheet.answer_key[i],start=obj.start,xy0=this.returnXYByCell(start.j+1,start.k+1);xy0=[xy0[0]-offset.left,xy0[1]-offset.top];var xy1=this.returnXYByCell(obj.start.j+1+(obj.word.length-1)*obj.increments.j,obj.start.k+1+(obj.word.length-1)*obj.increments.k);xy1=[xy1[0]-offset.left,xy1[1]-offset.top],$("#word_"+i+"_"+m.containerId).unbind().find("hr").show(),this.options.model.paper.path("M"+xy0[0]+","+xy0[1]+"L"+xy1[0]+","+xy1[1]).attr({"stroke-width":"10pt",stroke:"#9dbdff","stroke-linecap":"round",opacity:1})},handleKeys:function(e){var self=e.data.self,m=self.options.model;if(!e.altKey&&32!=e.keyCode&&0==m.keyboard.isStarted)return!0;if(m.keyboard.prevCell=[m.keyboard.activeCell[0],m.keyboard.activeCell[1]],e.altKey)switch(e.keyCode){case 85:return e.data.self.reset(!1),!1;case 81:e.data.self.showAnswer(),e.data.self.completed();break;default:return!0}else switch(e.keyCode){case 32:if(0!=m.keyboard.isStarted){if(m.keyboard.startLine){var obj=m.table.find("tr:nth-child("+m.keyboard.activeCell[1]+")").find("td:nth-child("+m.keyboard.activeCell[0]+")").find("span").removeClass("sc-selected").offset();self.startLine(obj.left,obj.top,self)}else self.endLine(self);return m.keyboard.startLine=!m.keyboard.startLine,!1}m.keyboard.isStarted=!0;break;case 37:m.keyboard.activeCell=[m.keyboard.activeCell[0]-1,m.keyboard.activeCell[1]];break;case 38:m.keyboard.activeCell=[m.keyboard.activeCell[0],m.keyboard.activeCell[1]-1];break;case 39:m.keyboard.activeCell=[m.keyboard.activeCell[0]+1,m.keyboard.activeCell[1]];break;case 40:m.keyboard.activeCell=[m.keyboard.activeCell[0],m.keyboard.activeCell[1]+1];break;default:return!0}m.keyboard.activeCell[0]<0&&(m.keyboard.activeCell[0]=m.size),m.keyboard.activeCell[0]>m.size&&(m.keyboard.activeCell[0]=0),0==m.keyboard.activeCell[1]&&(m.keyboard.activeCell[1]=m.size),m.keyboard.activeCell[1]>m.size&&(m.keyboard.activeCell[1]=1),e.preventDefault(),self.refreshKeysView(self)},refreshKeysView:function(self){var m=self.options.model,actCell=(m.table.find("tr:nth-child("+m.keyboard.prevCell[1]+")").find("td:nth-child("+m.keyboard.prevCell[0]+")").find("span").removeClass("sc-selected"),m.table.find("tr:nth-child("+m.keyboard.activeCell[1]+")").find("td:nth-child("+m.keyboard.activeCell[0]+")").find("span").addClass("sc-selected"));if(0==m.keyboard.activeCell[0]);else if(!m.keyboard.startLine){var offset=actCell.offset();self.moveLine(offset.left,offset.top,self)}},updateStatus:function(){for(var m=this.options.model,currentScore=0,i=0;i<m.pointsArr.length;i++)currentScore+=m.pointsArr[i];var pts=currentScore*(m.maxScore/m.pointsArr.length);pts=Math.round(10*pts)/10,m.currentScore=pts,pts==m.maxScore&&this.completed(),$("#statusText_"+m.containerId).html(m.scoreText+" "+pts+"/"+m.maxScore)},setState:function(jsonObj){var m=this.options.model;try{m.setState(jsonObj)}catch(e){console.log(e)}for(var i=0;i<m.pointsArr.length;i++)0!=m.pointsArr[i]&&this.showSingleAnswer(i);this.updateStatus()},getState:function(){return this.options.model.getState()},disableActivity:function(){this.options.model.draw.remove(),this._super()}}),SCPTController("Sortings",{},{init:function(){this.options.model.attempts++;var container=$("#"+this.options.model.containerId);this.options.model.randArrs=[],this.randomOrder=this.options.model.returnRandomOrder(this.options.model.cards.length),container.html(this.options.template,{labels:this.options.model.cards,sortLabels:this.options.model.sortLabels,offsetTop:parseInt(container.offset().top,10),id:this.options.model.containerId,color:this.options.model.backgroundColor,width:this.options.model.width,height:this.options.model.height,randArr:this.randomOrder,bigText:"true"==this.options.model.isBigText?"sc-bigText":""});for(var i=0;i<this.options.model.cards.length;i++){var obj=$("#"+this.options.model.getIdByIndex(i));this.options.model.startCoords[i]={x:obj.css("left"),y:obj.css("top")}}container.find(".sc-sort-image > img").each(function(){var img=new Image,t=$(this).parent().parent().parent().attr("id");img.onload=function(){var r,w=this.width,h=this.height;this.width>100&&(r=100/w,w=100,h=this.height*r),h>100&&(r=100/h,h=100,w*=r),$("#"+t).find("img").css({width:w+"px",height:h+"px"})},img.src=this.src}),this._super(),this.showDeckTop(this.options.model.cards.length)},revert:function(dragId){$("#"+this.options.model.getIdByIndex(dragId)).css({top:this.options.model.startCoords[dragId].y,left:this.options.model.startCoords[dragId].x})},bindEvents:function(self){$("#"+this.options.model.containerId).find(".sc-sort").bind("draginit",function(ev,drag){self.options.model.fromKeyBoard||drag.revert()}),$("#"+this.options.model.containerId).find(".sc-sort-sortTarget").each(function(index){$(this).bind("dropon",function(ev,drop,drag){var isTrue=0,dragId=drag.delegate.getAttribute("data-id"),dropId=drop.element[0].getAttribute("data-id");drag.delegate.getAttribute("target-id")==dropId&&(isTrue=1,drag.revert(!1),drag.position(new jQuery.Vector($(drop.element[0]).offset().left,$(drop.element[0]).offset().top)),$(drag.delegate).unbind()),isTrue?(-2==self.options.model.pointsArr[dragId]&&(self.options.model.currentScore+=isTrue),self.options.model.pointsArr[dragId]=dropId):self.options.model.pointsArr[dragId]=-1,isTrue||self.revert(dragId),self.playIsCorrect(isTrue),self.updateStatus();for(var isCompleted=!0,i=0,l=self.options.model.pointsArr.length;i<l;i++)if(self.options.model.pointsArr[i]<0){isCompleted=!1;break}isCompleted&&self.completed()})}),$("#"+this.options.model.containerId).find(".sc-sort-sortDeck").bind("click",function(){self.nextCard()}),$("#"+this.options.model.containerId).find("#sort_0_"+this.options.model.containerId).bind("click",function(){self.reDeal()}),$("#restart_"+this.options.model.containerId).bind("click",function(){self.reset()})},nextCard:function(){this.options.model.selectedObject++;for(var targetCard=this.randomOrder[this.options.model.selectedObject];this.options.model.pointsArr[targetCard]>-1&&targetCard<this.options.model.pointsArr.length;)this.options.model.selectedObject++,targetCard=this.randomOrder[this.options.model.selectedObject];$("#"+this.options.model.getIdByIndex(targetCard)).show().css({"z-index":this.options.model.currentZIndex++});for(var unshowed=0,i=0,l=this.options.model.pointsArr.length;i<l;i++)$("#"+this.options.model.getIdByIndex(i)).is(":visible")||unshowed++;this.showDeckTop(unshowed)},reDeal:function(){this.options.model.selectedObject=-1;for(var unshowed=0,i=0,l=this.options.model.pointsArr.length;i<l;i++)this.options.model.pointsArr[i]<0&&(unshowed++,$("#"+this.options.model.getIdByIndex(i)).hide());for(i=1;i<=3;i++)$("#sort_"+i+"_"+this.options.model.containerId).show();this.showDeckTop(unshowed)},showDeckTop:function(unshowed){unshowed<3&&($("#sort_3_"+this.options.model.containerId).hide(),unshowed<2&&$("#sort_2_"+this.options.model.containerId).hide(),unshowed<1&&$("#sort_1_"+this.options.model.containerId).hide())},updateStatus:function(){var pts=this.options.model.currentScore*(this.options.model.maxScore/this.options.model.pointsArr.length);pts=Math.round(10*pts)/10,$("#statusText_"+this.options.model.containerId).html(this.options.model.scoreText+" "+pts+"/"+this.options.model.maxScore);for(var notPlaced=0,i=0;i<this.options.model.pointsArr.length;i++)this.options.model.pointsArr[i]<0&&notPlaced++;$("#sort_sub_"+this.options.model.containerId).html(notPlaced+"/"+this.options.model.pointsArr.length)},switchToNext:function(){$("#sort_1_"+this.options.model.containerId).is(":visible")?this.nextCard():this.reDeal()},showAnswer:function(){for(var i=0,l=this.options.model.pointsArr.length;i<l;i++){var obj=$("#"+this.options.model.getIdByIndex(i)),target=$("#sortTarget_"+obj.attr("target-id")+"_"+this.options.model.containerId),container=$("#"+this.options.model.containerId);obj.css({left:target.offset().left-container.offset().left-4,top:target.offset().top-container.offset().top-4}).show()}this.nextCard()},setState:function(jsonObj){this._super(jsonObj),this.updateStatus();for(var unshown=0,i=0,l=this.options.model.pointsArr.length;i<l;i++)if(this.options.model.pointsArr[i]>-1){var target=$("#sortTarget_"+this.options.model.pointsArr[i]+"_"+this.options.model.containerId);$("#"+this.options.model.getIdByIndex(i)).css({left:target.position().left,top:target.position().top}).show()}else unshown++;this.showDeckTop(unshown)}}),SCPTController("TabbedPane",{},{init:function(){this.current=1,this.holder=$("#"+this.options.model.params.containerId).html("").addClass("tabbedpane").css({background:this.options.model.backgroundColor,border:"1px solid "+getMixedColor("#3c3c3c",this.options.model.backgroundColor,.5)}).append(this.options.template).children(".page"),this._wait_for_ready(this._super)},_wait_for_ready:function(_super,poll){var self=this;poll=poll||50,this.options.model._ready?self._start(_super):setTimeout(function(){self._wait_for_ready(_super,Math.min(poll+50,1500))},poll)},_start:function(_super){this._super=_super,this.holder.html(""),this.stretch=this.options.model.stretch,this.view=this["_tabspanel_view_"+this.options.model.tablocation](),this.view.tabs[0].css({background:this.options.model.backgroundColor});var loc=this.options.model.tablocation,orient=this.options.model.orient,tab=this.options.model.tab;tab instanceof Array||(tab=[tab]),this.tab_param="vertical"==orient?["height",this.view.tabs[0].outerHeight(!0)/tab.length]:["width",Math.min(this.view.tabs[0].outerWidth(!0)/tab.length,150)];for(var i=0,l=tab.length;i<l;i++)this._add_tab_bttn(loc,orient,tab[i],i+1),this._add_tab_desc(orient,tab[i]);if(this.show_tab(1),this.stretch){var stretch={height:"100%"};this.holder.css(stretch).parent().css(stretch);for(i=0,l=this.view.desc.length;i<l;i++)this.view.desc[i].css(stretch).children().css(stretch).children().css(stretch)}this.view.keys=this.holder.parent().find(".key-handler").attr("id","inputf_"+this.options.model.params.containerId),this._super(),this.holder.show()},_tabspanel_view_top:function(){return{tabs:[$('<div class="horizontal-tabs"></div>').appendTo(this.holder)],desc:[$('<div class="horizontal-desc"></div>').appendTo(this.holder)]}},_tabspanel_view_bottom:function(){return{desc:[$('<div class="horizontal-desc"></div>').appendTo(this.holder)],tabs:[$('<div class="horizontal-tabs"></div>').appendTo(this.holder)]}},_tabspanel_view_left:function(){return{tabs:[$('<div class="vertical-tabs"></div>').appendTo(this.holder)],desc:[$('<div class="vertical-desc"></div>').appendTo(this.holder)]}},_tabspanel_view_right:function(){return{desc:[$('<div class="vertical-desc"></div>').appendTo(this.holder)],tabs:[$('<div class="vertical-tabs"></div>').appendTo(this.holder)]}},_add_tab_bttn:function(loc,orient,tab,n){var evt_name="ontouchstart"in document.documentElement?"click":"mouseenter",l_color=getMixedColor("#ffffff",tab.color,.9),r_color=getMixedColor("#ffffff",tab.color,.5),self=this,tabColor=parseInt("0x"+tab.color.substr(tab.color.indexOf("#")+1))>8355711?"#000000":"#FFFFFF";return this.view.tabs.push($('<div class="'+orient+'-tab-bttn" style="background:'+tab.color+";"+this.tab_param[0]+":"+this.tab_param[1]+'px"><div style="color:'+tabColor+";"+this.tab_param[0]+":"+(this.tab_param[1]-10)+'px">'+tab.label+"</div></div>").appendTo(this.view.tabs[0])._lineargradient(loc,l_color,r_color).each(function(){$(this).bind(evt_name,function(){self.show_tab(n)})}).fadeTo(0,.3))},_add_tab_desc:function(orient,tab){var scroll_w="ontouchstart"in document.documentElement?4:12;tab.image=tab.image.image||tab.image||"",tab.img_h=tab.img_h||20,stretch=this.stretch,this.view.desc.push($('<div class="'+orient+'-tab-desc" style="background:'+getMixedColor("#ffffff",tab.color,.1)+';px"><div style="outline-width: 0px"><div style="min-height: '+tab.img_h+'px">'+tab.image+tab.content+"</div></div></div>").appendTo(this.view.desc[0]).each(function(){$(this).children("div").bind("keydown",function(evt){self.view.keys.trigger(evt)}),stretch||$(this).children("div").niceScroll({cursorwidth:scroll_w}),$(this).data("color",getMixedColor("#ffffff",tab.color,.1))}).hide());var tab_view=this.view.desc[this.view.desc.length-1];this.stretch||(tab_view.scroll=tab_view.children().first().getNiceScroll().hide()),this.element.parents(get_greymatter_class_name()).bind("isVisible",function(){tab_view.children().first().getNiceScroll().each(function(){this.updateScrollBar()})}),this.element.parents(get_greymatter_class_name()).bind("isHidden",function(){tab_view.children().first().getNiceScroll().hide()}.bind(this))},prev:function(){var n;n=1==this.current?this.view.tabs.length-1:this.current-1,this.show_tab(n)},next:function(){var n;n=this.current==this.view.tabs.length-1?1:this.current+1,this.show_tab(n)},show_tab:function(n){this.stretch||this.view.desc[this.current].scroll.hide(),this.view.tabs[this.current].fadeTo("fast",.3),this.view.desc[this.current].hide(),this.view.desc[this.current].children().getNiceScroll().hide(),this.current=n,this.view.desc[this.current].show(),this.view.tabs[this.current].fadeTo("fast",1),this.view.desc[this.current].children().getNiceScroll().show(),this.view.desc[this.current].children().getNiceScroll().each(function(){this.updateScrollBar()}),this.stretch||this.view.desc[this.current].scroll.show(),this.holder.css({background:this.view.desc[this.current].data("color")})},getState:function(jsonObj){return{tab:this.current}},setState:function(jsonObj){this.show_tab(parseInt(jsonObj.tab))},handleKeys:function(e){var self=e.data.self;switch(e.keyCode){case 38:case 37:self.prev();break;case 39:case 40:self.next();break;default:return!0}e.preventDefault()},reset:function(){},disableActivity:function(){this._super()}}),SCPTController("Timelines",{},{init:function(){var self=this,m=this.options.model;self.options.model.attempts++;var temp_image,container=$("#"+m.containerId);container.html(this.options.template,{id:m.containerId,color:m.backgroundColor,width:m.width,height:m.height,title:m.title,visualContainers:m.visualContainers,ordermethod:m.ordermethod,partWidth:m.partWidth,events:m.events,closeTxt:m.closeTxt}),this._super(),m.cont=$("<div style='opacity:0;z-index:-1;position:absolute;'>12345</div>");for(var i=0;i<m.events.length;i++)temp_image=void 0===m.events[i].image?"data:image/gif;base64,R0lGODlhAQABAIAAAP///wAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==":m.events[i].image,m.cont.append($("<img src='"+temp_image+"'></img>"));container.parent().prepend(m.cont),m.img=$("<img  style='float: left; margin: 0px 10px 10px 0px;' src=''/>"),$("#timeline_popupImg_"+m.containerId).parent().prepend(m.img);document.documentElement;var on_show=$.oneshot(function(){self.adjustSizeAndScroller(),setTimeout(function(){self.adjustSizeAndScroller(),$("#"+m.containerId).children().eq(0).css({visibility:"visible"})},200)}),mask=container.parents(get_greymatter_class_name());0==mask.length||mask.is(":visible")?on_show():mask.bind("isVisible",on_show)},adjustSizeAndScroller:function(){var m=this.options.model,totalW=$("#timeline_container_"+m.containerId)[0].scrollWidth,table=$("#timeline_container_"+m.containerId).find("table:first"),tableW=table.width();table.find("td > div").css("height",table.find("td:first").height()-2+"px"),table.find("td > div > div").css("margin-top",table.find("td:first").height()-22+"px"),table.find("td > div > div > div").css("line-height","100%");var lastTd=table.find("td:last").children().first();lastTd.css({width:totalW-tableW+lastTd.width()+"px"});var sum=0;table.find("td > div").each(function(){$(this).parent().width($(this).width()),sum+=$(this).parent().width()}),table.width(sum+"px");for(var pos=[],i=0;i<m.events.length;i++){var obj=$("#timeline_label_"+i+"_"+m.containerId);pos[i]=[obj.position().left,obj.position().left+obj.width()+20]}for(var resPos=[],j=0;j<m.events.length;j++){for(i=0;i<resPos.length&&resPos[i]>pos[j][0];)i++;resPos[i]=pos[j][1],$("#timeline_label_"+j+"_"+m.containerId).css("top",20*(i+1)+"px");$("#timeline_label_"+j+"_"+m.containerId)}var _flag=!0,tgt1=(obj=$("#timeline_container_"+m.containerId),$("#timeline_sm_"+m.containerId));if(obj.children().eq(0).width()>obj.width()){tgt1.width($("#timeline_sb_"+m.containerId).width()*obj.width()/obj.children().eq(0).width());var tw=$("#timeline_sb_"+m.containerId).width()-tgt1.width();$("#timeline_sm_"+m.containerId).bind("draginit",function(ev,drag){_flag=!1,drag.horizontal(),drag.limit($("#timeline_sb_"+m.containerId))}).bind("dragmove",function(ev,drag){obj.scrollLeft((tgt1.position().left-31)*(obj.children().eq(0).width()-obj.width())/tw)}).bind("dragend",function(){_flag=!0}),$("#timeline_container_"+m.containerId).scroll(function(ev){_flag&&tgt1.css({left:tw*obj.scrollLeft()/(obj.children().eq(0).width()-obj.width())+31+"px"})}),$("#timeline_la_"+m.containerId).click(function(){var sl=obj.scrollLeft()-.1*(obj.children().eq(0).width()-obj.width());sl<0&&(sl=0),obj.scrollLeft(sl)}),$("#timeline_ra_"+m.containerId).click(function(){var sl=obj.scrollLeft()+.1*(obj.children().eq(0).width()-obj.width());sl/(obj.children().eq(0).width()-obj.width())>1&&(sl=obj.children().eq(0).width()-obj.width()),obj.scrollLeft(sl)})}else $("#timeline_sc_"+m.containerId).hide()},bindEvents:function(){var m=this.options.model;$("#timeline_closeButton_"+m.containerId).bind("click",function(){$("#timeline_popup_"+m.containerId).hide().children().first().getNiceScroll().remove()}).hover(function(){$(this).css({"border-color":"#c1f0ae"})},function(){$(this).css({"border-color":"#9ca2a2"})});for(var i=0;i<m.events.length;i++)$("#timeline_label_"+i+"_"+m.containerId).bind("click",function(j,self){return function(){self.showPopup(j)}}(i,this))},showCorrectDate:function(date){var retDate="";(date=(date+="").split("/")).length<3&&(date=[0,0,date[0]]);for(var i=0;i<3;i++)retDate+="0"==date[i]?"":"/"+date[i];return retDate.substring(1)},showPopup:function(slideNumber){var m=this.options.model,ev=m.events[slideNumber],title="",text="";ev.title+""!="[object Object]"&&ev.title+""!="undefined"&&(title+="<b>"+ev.title+"</b>"),"numbered"==m.ordermethod?title="<b>"+this.showCorrectDate(ev.date)+". </b>"+title:(title+=" "+this.showCorrectDate(ev.date),ev.end+""!="[object Object]"&&(title+=" - "+ev.end)),ev.content+""!="[object Object]"&&ev.content+""!="undefined"&&(text=ev.content),$("#timeline_popupTitle_"+m.containerId).html(title),$("#timeline_popupText_"+m.containerId).html(text),$("#timeline_popupImg_"+m.containerId).hide(),ev.image?(m.img.css("float","left"),$("#timeline_popupImg_"+m.containerId).css("float","left")):(m.img.css("float","right"),$("#timeline_popupImg_"+m.containerId).css("float","right")),$("#timeline_popup_"+m.containerId).show(),m.img[0].src=m.cont.find("img").eq(slideNumber)[0].src,$("#timeline_popupImg_"+m.containerId)[0].src=m.cont.find("img").eq(slideNumber)[0].src,$("#timeline_popupImg_"+m.containerId).css({width:m.cont.find("img").eq(slideNumber)[0].width+"px",height:m.cont.find("img").eq(slideNumber)[0].height+"px"}),m.img[0].display="inline",setTimeout(function(){var obj=$("#timeline_popup_"+m.containerId).show();"ontouchstart"in document.documentElement?obj.children().first().niceScroll({cursorwidth:4,touchbehavior:!0,grabcursorenabled:!1}):$(".timelinePopupText").css("overflow","auto")},300)},updateStatus:function(){},handleKeys:function(e){}});
